# Agent Design Best Practice

æƒ³è®©Agent æ—¢ **è·‘å¾—å¿«ã€èŠ±å¾—å°‘ã€è¿˜ä¸ç¿»è½¦**ï¼Œå…‰æœ‰â€œå¤§æ¨¡å‹èƒ½åŠ›â€è¿œè¿œä¸å¤Ÿï¼Œæ›´å…³é”®çš„æ˜¯ï¼šä½ å¦‚ä½•ç»™å®ƒå–‚ä¸Šä¸‹æ–‡ã€å–‚å·¥å…·ã€å–‚åé¦ˆã€‚
 è¿™å°±æ˜¯æ‰€è°“ **Context Engineering**ã€‚

7 æ¡å¯ç«‹å³è½åœ°çš„å·¥ç¨‹åŸåˆ™ï¼š

| #    | æŠ€æœ¯å…³é”®è¯                                    | ä¸€å¥è¯ä»·å€¼                                                   |
| ---- | --------------------------------------------- | ------------------------------------------------------------ |
| 1    | **KV-Cache å¤ç”¨**                             | é”æ­»å‰ç¼€ã€åªè¿½åŠ ï¼Œè®©â€œå†å²â€ä¸€æ¬¡ç¼“å­˜ï¼Œå¤„å¤„å¤ç”¨ï¼Œprefill èŠ±è´¹é™ä½æ•°å€ |
| 2    | **Logits æ©ç **                               | å·¥å…·ä¸åˆ ï¼Œåªâ€œé®â€ï¼›ç¼“å­˜ä¸ç¢ï¼Œå†³ç­–ä¸ä¹±                         |
| 3    | **æ–‡ä»¶ç³»ç»Ÿå³ä¸Šä¸‹æ–‡**                          | å¤§æ–‡æœ¬å†™æ–‡ä»¶ã€ä¸Šä¸‹æ–‡ç•™ç´¢å¼•ï¼Œ128 K ä¹Ÿè£…å¾—ä¸‹æ•´åº§å›¾ä¹¦é¦†         |
| 4    | **Recitation èƒŒè¯µé”šå®š**                       | ä¸åœæŠŠç›®æ ‡å†™åˆ°å°¾éƒ¨ï¼Œæ¨¡å‹å§‹ç»ˆè®°å¾—è‡ªå·±è¦å¹²ä»€ä¹ˆ                 |
| 5    | **é”™è¯¯ç•™ç—•**                                  | æŠŠå¤±è´¥ç—•è¿¹ç•™åœ¨ä¸Šä¸‹æ–‡ï¼Œè®©æ¨¡å‹â€œåƒä¸€å ‘é•¿ä¸€æ™ºâ€                   |
| 6    | **å Few-Shot åŒè´¨åŒ–**                        | æ¨¡æ¿å¤šæ ·åŒ–ï¼Œæ‰“ç ´â€œå¤åˆ¶ç²˜è´´â€èŠ‚å¥é”å®š                           |
| 7    | **Predicted Outputsâ€”â€”Skip, Donâ€™t Regenerate** | å¤§æ–‡ä»¶å°æ”¹åŠ¨æ—¶ï¼Œå·²çŸ¥æ–‡æœ¬ç›´æ¥è·³è¿‡è§£ç ï¼Œå›å¤å¿« 3-5Ã—            |



## 1. KV-Cache ç¼“å­˜å¤ç”¨ä¼˜åŒ–

### ğŸŒŸ ä»‹ç»ä¸ç›®çš„

KV-Cacheï¼ˆKey-Value Cacheï¼Œé”®å€¼ç¼“å­˜ï¼‰æ˜¯å¤§æ¨¡å‹æ¨ç†è¿‡ç¨‹ä¸­çš„ä¸€ç§åŠ é€Ÿæœºåˆ¶ã€‚å®ƒçš„æœ¬è´¨æ˜¯â€œè®°ä½å·²ç»ç®—è¿‡çš„ä¸œè¥¿ï¼Œä¸å†ç™½ç™½é‡ç®—ä¸€éâ€ã€‚å¦‚æœèƒ½å……åˆ†åˆ©ç”¨KV-Cacheï¼Œå¯ä»¥æå¤§é™ä½å“åº”æ—¶é—´å’ŒæœåŠ¡å™¨æˆæœ¬ï¼Œç›´æ¥è®©AIå’Œç”¨æˆ·ä½“éªŒâ€œé£èµ·æ¥â€ã€‚

![images](https://github.com/xinyuwei-david/david-share/blob/master/Agents/Agent-Design-Practice/images/1.png)

### ğŸ¯ è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜

- **ä¸Šä¸‹æ–‡è¶Šæ¥è¶Šé•¿**ï¼šAgentå¸¦ç€è¶Šæ¥è¶Šå¤šâ€œå†å²â€å¾€å‰æ¨ï¼Œæ¯ä¸€æ­¥éƒ½è¦æŠŠæ‰€æœ‰å†å²å–‚è¿›å¤§æ¨¡å‹ã€‚
- **æ¨ç†å•ä»·ä¸Šå‡**ï¼šæ¯ä¸€æ­¥çš„è¾“å…¥tokenä¸Šä¸‡ï¼Œè¾“å‡ºå´å¯èƒ½åªæœ‰10ä¸ªï¼Œä¼ ä¸€å †å†å²åªä¸ºæ¨¡å‹â€œå›å¿†â€ï¼Œæˆæœ¬æƒŠäººã€‚
- **ç¼“å­˜å¤±æ•ˆé£é™©**ï¼šåªè¦ä¸Šä¸‹æ–‡å“ªæ€•ä¸€ä¸ç‚¹ä¸åŒï¼ˆå“ªæ€•æ˜¯æ—¶é—´æˆ³ã€ç©ºæ ¼ã€æ— å…³é¡ºåºï¼‰ï¼Œæ‰€æœ‰ç¼“å­˜éƒ½æ²¡äº†ï¼ŒçœŸé‡‘ç™½é“¶çš„ç®—åŠ›å…¨ä½œåºŸã€‚

### ğŸ” å¸¸è§è¯¯åŒºä¸è‡´å‘½é™·é˜±

**æœ€å¤§é™·é˜±å°±æ˜¯åœ¨ç³»ç»Ÿæç¤ºã€é¦–æ¡ä¸Šä¸‹æ–‡é‡Œæ”¾â€œåŠ¨æ€å†…å®¹â€**ï¼Œæ¯”å¦‚ï¼š

- ç²¾ç¡®åˆ°ç§’çš„æ—¶é—´æˆ³
- ä¼šè¯/ç”¨æˆ·å”¯ä¸€ID
- éšæœºç§å­ã€é¡ºåºå·
- å·¥å…·æè¿°é¡ºåºæ¯æ¬¡éƒ½ä¸ä¸€æ ·ï¼ˆJSONæ— åºï¼‰

è¿™äº›éƒ½ä¼šè®©â€œæ˜æ˜99%å†…å®¹ä¸€æ ·â€çš„ä¸¤ä¸ªè¯·æ±‚ï¼Œç¼“å­˜æ ¹æœ¬æ— æ³•å¤ç”¨ï¼Œæ¯æ¬¡éƒ½å˜æˆå…¨æ–°é•¿æ–‡æœ¬æ¨ç†ã€‚

**ç°å®æ¡ˆä¾‹**

> ä¹‹å‰æœ‰å›¢é˜Ÿä¸ºâ€œè®©AIèƒ½è¯´å‡ºå½“å¤©æ—¥æœŸâ€ï¼Œåœ¨system prompté‡Œå¡`"å½“å‰æ—¶é—´:{datetime.now()}"`ï¼Œç»“æœç¼“å­˜å‘½ä¸­ç‡ä»98%â†’<5%ï¼Œæ¯æœˆäº‘è´¦å¤šå‡ ä¸‡ç¾å…ƒã€‚

### ğŸ› ï¸ æ­£ç¡®å·¥ç¨‹å®ç°

1. **ä¸¥æ ¼é”å®šæç¤ºå‰ç¼€å†…å®¹ï¼Œä¸€å­—ä¸å˜**ï¼š

   ```
   SYSTEM_PROMPT = "ä½ æ˜¯ä¸“ä¸šAIåŠ©æ‰‹ã€‚è¯·ä¸¥æ ¼éµå¾ªJSONæ ¼å¼å›å¤ã€‚"
   # åƒä¸‡åˆ«æ”¾æ—¶é—´ã€session-idç­‰
   ```

   

2. **åŠ¨æ€ä¿¡æ¯ç”¨â€œå·¥å…·è°ƒç”¨â€è·å–**ï¼š

   - ç”¨æˆ·è¦æ—¶é—´ï¼Œåƒfunction-callingè¿™æ ·è®©æ¨¡å‹è‡ªå·±å‘èµ· get_time å·¥å…·è°ƒç”¨ï¼Œå†æŠŠ`{"now": "2025-01-01T12:00:00"}`è¿™æ ·çš„ç»“æœï¼Œè¿½åŠ åˆ°æœ€åä¸€æ¡ä¸Šä¸‹æ–‡é‡Œã€‚
   - è¿™ä¸ä¼šå½±å“å‰ç¼€ï¼Œä¸ç ´åç¼“å­˜ã€‚

3. **æ‰€æœ‰é•¿å†…å®¹ï¼ˆå¦‚å·¥å…·JSONã€schemaï¼‰åºåˆ—åŒ–æ—¶å¿…é¡»ä¿è¯é¡ºåºå”¯ä¸€**ï¼š

   ```
   import json
   tool_schema = json.dumps(tools, sort_keys=True)
   ```

   

4. **ä¸Šä¸‹æ–‡åªèƒ½â€œè¿½åŠ â€ï¼Œç¦æ­¢æ’ç©ºã€åˆ é™¤ã€å›æ»š**

   - æ°¸è¿œåªèƒ½ä¸€è¡Œä¸€è¡Œå¾€åæ¥ï¼Œä¸èƒ½å›åˆ°å‰é¢â€œè¡¥ä¸€åˆ€â€ã€‚

5. **å¤šå¹¶å‘æˆ–åˆ†å¸ƒå¼æ—¶ï¼Œç”¨session-idè®©åŒä¸€è¯·æ±‚æ€»æ˜¯å‘½ä¸­åŒä¸€worker**ï¼ˆä¸ç„¶ç¼“å­˜è·¨workeræ— æ•ˆï¼‰ã€‚

### âœ… æˆåŠŸæ•ˆæœ

- æœ‰æ•ˆç¼“å­˜å‘½ä¸­ç‡èƒ½ä»10%æå‡åˆ°95%+
- åŸºæœ¬ä¿è¯æ— è®ºå†å²å¤šé•¿ï¼Œæ¨ç†æ¯«ç§’å“åº”ï¼Œå•æ­¥æˆæœ¬é™ä¸€ä¸¤ä¸ªæ•°é‡çº§
- å¤§é‡å¹¶å‘æ—¥å¸¸æµé‡ä¸å†æ³¢åŠ¨

------

## 2. Logitsæ©ç  æ§åˆ¶å·¥å…·åŠ¨æ€

### ğŸŒŸ ä»‹ç»ä¸ç›®çš„

Logitsæ©ç ï¼ˆLogits Maskingï¼‰æ˜¯ä¸€ç§â€œåªè®©æ¨¡å‹åœ¨è§£ç æ—¶çœ‹åˆ°å…è®¸çš„é€‰é¡¹ï¼Œå…¶å®ƒéƒ½ç›¸å½“äºâ€˜è§†è€Œä¸è§â€™â€çš„æŠ€æœ¯ã€‚**ä¸åˆ é™¤ã€ä¸è£å‰ªã€ä¸å¹²æ‰°ç‰©ç†å†…å®¹ï¼Œåªåœ¨é€‰æ‹©åˆ†æ•°é˜¶æ®µå°±å¹²æ‰ä¸è¯¥å‡ºç°çš„é€‰é¡¹**ã€‚

![images](https://github.com/xinyuwei-david/david-share/blob/master/Agents/Agent-Design-Practice/images/2.png)

### ğŸ¯ è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜

- éšç€Agentèƒ½åŠ›å¢å¼ºï¼Œå·¥å…·æ•°é‡çˆ†ç‚¸ï¼Œä¸åŒåœºæ™¯å…¶å®åªåº”è®©æ¨¡å‹è§åˆ°ä¸€å°éƒ¨åˆ†å·¥å…·ã€‚
- ä¼ ç»Ÿâ€œæ¯æ¬¡æŠŠæ— ç”¨å·¥å…·æè¿°ç›´æ¥åœ¨ä¸Šä¸‹æ–‡åˆ é™¤/è£å‰ªâ€ï¼Œä¼šå¯¼è‡´â€œå‰æ–‡å˜åŠ¨â€â†’â€œç¼“å­˜å¤±æ•ˆâ€ã€‚
- æŸäº›å†å²åŠ¨ä½œç”¨äº†â€œæ—§å·¥å…·â€ï¼Œä½ ç°åœ¨åˆ äº†æè¿°ï¼Œæ¨¡å‹ä¼šæ‡µé€¼ã€‚

### ğŸ” å¸¸è§è¯¯åŒºæˆ–é”™è¯¯åšæ³•

- æ¯é‡åˆ°ä¸åŒåœºæ™¯å°±å…ˆåˆ æ‰å‡ åä¸ªå·¥å…·çš„æç¤ºï¼Œç„¶åæ‹¼ä¸€ä¸ªæ–°promptã€‚è¿™ä¼šæ¯æ¬¡éƒ½è®©cacheå‘½ä¸­ç‡é™åˆ°0ã€‚
- ç›´æ¥ç‰©ç†åˆ é™¤å†…å®¹ï¼Œå¿½è§†å‰åæ–‡å®é™…å¼•ç”¨å…³ç³»ã€‚

### ğŸ› ï¸ æ­£ç¡®å·¥ç¨‹å®ç°

1. **å…¨é‡ä¿ç•™æ‰€æœ‰å·¥å…·æè¿°äºä¸Šä¸‹æ–‡**ï¼Œæ— è®ºä½•æ—¶ä½•åœ°ï¼Œä¸€å­—éƒ½ä¸åˆ ã€‚

2. **ç”¨æ¨¡å‹APIçš„ logit_bias åŠŸèƒ½ï¼Œå¯¹æ‰€æœ‰å¤„äºâ€œç¦ç”¨çŠ¶æ€â€çš„å·¥å…·åé¦–tokenï¼Œæ‰“ä¸Šæä½åˆ†æ•°ï¼ˆå¦‚-100ï¼‰**ã€‚è¿™æ ·æ¨¡å‹å³ä½¿â€œçœ‹è§â€å®ƒï¼Œä¹Ÿä¸ä¼šâ€œé€‰ä¸­â€å®ƒã€‚

3. **æ­£ç¡®åŒºåˆ†å•tokenå·¥å…·å’Œå¤štokenå·¥å…·**ã€‚ä¸€èˆ¬å¯¹â€œé¦–tokenâ€æ©ç å³å¯ï¼Œæç«¯ä¸¥è°¨å¯æ‰€æœ‰tokenéƒ½æ©ç ã€‚

   ç¤ºä¾‹ï¼ˆOpenAI APIï¼‰ï¼š

   ```
   def mask_tools(allowed_prefix="browser_"):
       return {token_id: -100 for tool,token_id in all_tool_token_ids.items()
               if not tool.startswith(allowed_prefix)}
   ```

   

4. çŠ¶æ€åˆ‡æ¢æ—¶ï¼Œåªå˜æ›´æ©ç æ˜ å°„è¡¨ï¼Œä¸æ›´åŠ¨ä¸Šä¸‹æ–‡ã€‚

### âœ… æˆåŠŸæ•ˆæœ

- åŠ¨æ€ç®¡ç†å·¥å…·å˜æˆæ¯«ç§’çº§ï¼Œä¸ä¼šç ´åå†å²ç¼“å­˜ã€‚
- ç³»ç»Ÿæ€§èƒ½å—â€œå·¥å…·æ•°é‡â€å½±å“æå°ã€‚
- å·¥å…·å¼•ç”¨ä¸€è‡´æ€§å§‹ç»ˆä¿æŒã€‚

------

## 3. æ–‡ä»¶ç³»ç»Ÿå³ä¸Šä¸‹æ–‡ï¼ˆå¤–åŒ–è®°å¿†ï¼‰

### ğŸŒŸ ä»‹ç»ä¸ç›®çš„

å¤§æ¨¡å‹ä¸Šä¸‹æ–‡å†å¤§ï¼Œæ€»æœ‰ä¸Šçº¿ï¼ˆå¦‚ChatGPTä¸Šä¸‹æ–‡128K tokenï¼‰ã€‚ç”¨æˆ·çš„è¾“å…¥å’Œå†å²ã€æŠ“å–ç½‘é¡µã€è¯»å¤§PDFå¾ˆå®¹æ˜“çªç ´é™åˆ¶ã€‚æ–‡ä»¶ç³»ç»Ÿå³ä¸Šä¸‹æ–‡ï¼Œå°±æ˜¯**è®©æ¨¡å‹é€šè¿‡å·¥å…·ä¸»åŠ¨å°†å¤§æ–‡æœ¬å­˜æ–‡ä»¶ã€åªç•™ä¸‹ä¾¿äºç´¢å¼•çš„è·¯å¾„åœ¨ä¸Šä¸‹æ–‡é‡Œ**ã€‚

![images](https://github.com/xinyuwei-david/david-share/blob/master/Agents/Agent-Design-Practice/images/3.png)

### ğŸ¯ è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜

- é‡åˆ°å¤§æ–‡æœ¬ï¼Œä¾‹å¦‚ç½‘é¡µã€PDFã€ä»£ç ï¼Œæ— æ³•å…¨éƒ½å¡è¿›promptã€‚
- åªé æ‘˜è¦æˆ–åˆ‡ç‰‡ï¼Œä¸‡ä¸€ä¸¢æ‰å…³é”®ç»†èŠ‚ï¼Œåç»­ä»»åŠ¡å°±æŒ‚äº†ã€‚
- åƒä¸‡ä¸è¦è®©æ¨¡å‹ä¾èµ–â€œè‡ªå·±å…¨è®°ä½â€ï¼Œè®©å®ƒä¹Ÿèƒ½â€œæŸ¥å­—å…¸â€ã€‚

### ğŸ” å¸¸è§è¯¯åŒºæˆ–é”™è¯¯åšæ³•

- ç›´æ¥æŠŠé•¿ç½‘é¡µå…¨æ–‡ã€åå‡ é¡µPDFå¡promptï¼Œå¯¼è‡´è¶…çª—å£æˆ–æ¨ç†æ…¢ã€å‹ç¼©æˆæœ¬é«˜ã€‚
- å‹ç¼©æ‘˜è¦ä¸å¯é€†ï¼ˆåˆ äº†å°±æ‰¾ä¸å›ï¼‰ï¼Œæ¨¡å‹å¿˜æ‰é‡è¦ä¿¡æ¯ã€‚

### ğŸ› ï¸ æ­£ç¡®å·¥ç¨‹å®ç°

1. **å®šä¹‰ file_write / file_read å·¥å…·**ï¼Œå…è®¸æ¨¡å‹è‡ªå·±æŠŠå¤§æ–‡æœ¬å­˜ç›˜ï¼Œç„¶ååªç”Ÿæˆç®€çŸ­çš„å­˜å‚¨ç´¢å¼•ï¼ˆå¦‚ï¼šâ€œå·²ä¿å­˜è‡³file-xxxâ€ï¼‰ã€‚
2. **åœ¨ä¸Šä¸‹æ–‡åªç•™ã€è·¯å¾„+ç®€è¦æ‘˜è¦ã€‘ï¼Œæ­£æ–‡æœ¬å»æ–‡ä»¶â€œåšè®°å¿†â€**ï¼Œå‡ åƒå­—åªæ¶ˆè€—å‡ åtokenã€‚
3. **åç»­ä»»ä½•ä»»åŠ¡ï¼Œéƒ½èƒ½é€šè¿‡file_readå·¥å…·å–å›åŸæ–‡è€Œä¸ä¼šä¸¢å¤±ä¿¡æ¯**ã€‚

### âœ… æˆåŠŸæ•ˆæœ

- é•¿é“¾ä»»åŠ¡çš„ä¸Šä¸‹æ–‡é•¿åº¦ä¿æŒçº¿æ€§ã€‚
- æ”¯æŒâ€œä»»æ„å¤šå†å²/å¤§æ–‡ä»¶â€é›¶ä¿¡æ¯ä¸¢å¤±ã€‚
- æ¨ç†ä»£ä»·æ’å®šï¼Œä½“éªŒæµç•…ã€‚

------

## 4. Recitationâ€œèƒŒè¯µé”šå®šâ€

### ğŸŒŸ ä»‹ç»ä¸ç›®çš„

LLMåšé•¿ä»»åŠ¡æ—¶ï¼Œæ³¨æ„åŠ›ä¸»è¦é›†ä¸­åœ¨è¾“å…¥çš„â€œå°¾éƒ¨â€ï¼›ç¦»è¾“å‡ºè¶Šè¿œï¼Œæ¨¡å‹è®°å¿†åŠ›è¶Šå·®ã€‚â€œRecitationâ€å°±æ˜¯è®©Agent**åå¤åœ¨ä¸Šä¸‹æ–‡æœ«å°¾â€œèƒŒè¯µâ€ç›®æ ‡(todo)ï¼ŒæŠŠç›®æ ‡æ—¶åˆ»æ¨åˆ°æ¨¡å‹è®°å¿†çª—å£â€œæ–°é²œåŒºâ€ã€‚**

![images](https://github.com/xinyuwei-david/david-share/blob/master/Agents/Agent-Design-Practice/images/4.png)

### ğŸ¯ è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜

- é•¿æµç¨‹ã€å¤æ‚è§„åˆ’æƒ…å†µä¸‹ï¼Œæ¨¡å‹å¼€å§‹å®¹æ˜“åé¢å°±ä¸¢ä¸‰è½å››ã€‚
- â€œlost-in-the-middleâ€é—®é¢˜ï¼Œç›®æ ‡è®°ä¸ä½ï¼Œåšäº‹å®Œå…¨å˜æˆâ€œä¹ æƒ¯æ€§æ¬ç –â€ã€‚

### ğŸ” å¸¸è§è¯¯åŒºå’Œå¤±è´¥æ¡ˆä¾‹

- è®¤ä¸ºâ€œåªè¦ç›®æ ‡å†™åœ¨å¾ˆæ—©çš„ä½ç½®å°±å¤Ÿäº†â€ï¼›å®é™…ä¸Šé•¿promptè¶…è¿‡å‡ åƒtokenåå‰é¢çš„å†…å®¹å‡ ä¹ä¸èµ·ä½œç”¨ã€‚
- æ¯æ­¥æ‰§è¡Œå®Œä¸æ€»ç»“å½“ä¸‹ç›®æ ‡ï¼Œæ¨¡å‹æ¯æ¬¡åªå…³æ³¨å±€éƒ¨å†å²ï¼Œç›®æ ‡æ¼‚ç§»ææ˜“å‘ç”Ÿã€‚

### ğŸ› ï¸ æ­£ç¡®å·¥ç¨‹å®ç°

1. **æŠŠæ€»ç›®æ ‡/å½“å‰è®¡åˆ’ç»´æŠ¤åˆ°todo.mdç­‰å›ºå®šâ€œå¤–éƒ¨æ–‡ä»¶â€é‡Œ**ï¼Œæ¨¡å‹èƒ½æŸ¥èƒ½å†™ã€‚
2. **æ¯èµ°ä¸€æ­¥å°±è‡ªåŠ¨å°†todoçš„æœ€æ–°å†…å®¹æ‘˜è¦æˆ3-5è¡Œå†è´´åˆ°ä¸Šä¸‹æ–‡ç»“å°¾**ã€‚
3. ç¡®ä¿æ— è®ºæ¨è¿›äº†å¤šå°‘æ­¥ï¼Œæ¨¡å‹æ¨ç†æ—¶æ€»èƒ½â€œè¯»åˆ°â€æ ¸å¿ƒç›®æ ‡ã€‚

### âœ… æˆåŠŸæ•ˆæœ

- ç›®æ ‡é—å¿˜ç‡ã€è·‘åç‡å¤§å¹…ä¸‹é™ã€‚
- å¯¹è¯é•¿æœŸè¿è´¯æ€§ç¨³å®šæå‡ã€‚
- æ‰¹å¤„ç†/å¤æ‚å·¥ç¨‹æµæå¤§é™æœ¬ã€‚

------

## 5. é”™è¯¯ç•™ç—•ï¼ˆè‡ªé€‚åº”è‡ªæˆ‘ä¿®æ­£ï¼‰

### ğŸŒŸ ä»‹ç»ä¸ç›®çš„

å¤§å¾ªç¯ã€å¤æ‚ä»»åŠ¡ä¸€å®šä¼šçŠ¯é”™ã€‚ç•™ç—•çš„ç­–ç•¥å°±æ˜¯**ä¸æ©é¥°å¤±è´¥ï¼Œè€Œè¦è®©æ¨¡å‹æ—¶åˆ»â€œçœ‹åˆ°æ›¾ç»æ‘”è¿‡çš„å‘â€â€”â€”è®©æ¨¡å‹çš„â€œè®°å¿†â€é‡ŒåŒ…å«é”™è¯¯ä¸å…¶åæœï¼Œå®ç°ç»éªŒç´¯ç§¯ã€‚**

![images](https://github.com/xinyuwei-david/david-share/blob/master/Agents/Agent-Design-Practice/images/5.png)

### ğŸ¯ è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜

- â€œæ— è„‘resetâ€å¯¼è‡´åŒæ ·çš„é”™è¯¯ä¸€çŠ¯å†çŠ¯ï¼›ä¸å­¦ä¹ çš„AI=æ­»æ¿å·¥ç¨‹ã€‚
- å¦‚æœæ¯è½®é”™è¯¯éƒ½è¢«try/exceptåæ‰æˆ–æ¸…ç†ï¼Œæ¨¡å‹æ— æ³•é€šè¿‡ä¸Šä¸‹æ–‡å­¦ä¹ â€œè¿™é‡Œæœ‰å‘â€ã€‚

### ğŸ” å¸¸è§è¯¯åŒºå’Œåä¾‹

- æ¯æ¬¡å·¥å…·æŠ¥é”™åªåšretry/å›æ»šï¼Œä¸è®©LMçœ‹åˆ°çœŸå®å †æ ˆ/æŠ¥é”™å†…å®¹ã€‚
- æ‹…å¿ƒå±•ç¤ºå¤±è´¥è®©ä¸Šä¸‹æ–‡â€œæ±¡æŸ“â€ï¼Œåè€Œä¸¢æ‰æœ€æœ‰ä»·å€¼çš„åé¦ˆä¿¡å·ã€‚

### ğŸ› ï¸ æ­£ç¡®å·¥ç¨‹å®ç°

1. **é‡åˆ°ä»»ä½•é”™è¯¯éƒ½åŸæ ·æŠŠå †æ ˆã€æŠ¥é”™ã€è¾“å…¥ã€é”™è¯¯ç±»å‹ç­‰è¯¦ç»†ä¿¡æ¯â€œè¿½åŠ åˆ°ä¸Šä¸‹æ–‡â€**ï¼Œç¦æ­¢ç²¾ç®€/æ¸…ç†ã€‚
2. **å¤ç›˜æ—¥å¿—æ ¼å¼éœ€æ¸…æ™°æ˜¾ç¤ºé”™è¯¯çŠ¶æ€**ï¼Œæ¨¡å‹çœ‹åˆ°æœ‰â€œå¤±è´¥â€å‡ ç‡ä¼šä¸»åŠ¨é¿å¼€ç±»ä¼¼æ“ä½œã€‚
3. **é“¾è·¯ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶ï¼Œä¿ç•™æ‰€æœ‰é”™è¯¯ï¼Œä¸å› é‡è¯•è€Œæ¸…ç©ºä»»ä½•trace**ã€‚

### âœ… æˆåŠŸæ•ˆæœ

- ç³»ç»Ÿæ€§é”™è¯¯å¤§å¹…å‡å°‘åŒä¸€ä½ç½®é‡è¯•æ¬¡æ•°ã€‚
- å·¥å…·è°ƒç”¨è¶Šæ™ºèƒ½ï¼Œåç»­æ•´ä½“æˆåŠŸç‡è¶Šé«˜ã€‚
- å·¥ç¨‹å¸ˆdebugæ›´å®¹æ˜“å®šä½æ ¹å› ã€‚

------

## 6. åFew-ShotåŒè´¨åŒ–ï¼ˆå¤šæ ·åŒ–é˜²æ¨¡å¼é™·é˜±ï¼‰

### ğŸŒŸ ä»‹ç»ä¸ç›®çš„

Few-Shotæœ¬æ˜¯æ¨¡å‹â€œç¤ºèŒƒå­¦ä¹ â€ã€‚ä½†æ‰¹å¤„ç†æˆ–æµæ°´çº¿ä»»åŠ¡ä¸­ï¼Œ**è¿‡äºç»Ÿä¸€/æ ‡å‡†çš„ä¸Šä¸‹æ–‡æ ·ä¾‹å…¶å®æ˜¯ç»™æ¨¡å‹æŒ–å‘â€”â€”å®ƒä¼šè¿‡åº¦æ¨¡ä»¿è€Œå¿˜äº†è‡ªæˆ‘å†³ç­–ã€‚**

![images](https://github.com/xinyuwei-david/david-share/blob/master/Agents/Agent-Design-Practice/images/6.png)

### ğŸ¯ è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜

- AIå®¹æ˜“äº§ç”Ÿâ€œé¡ºæ‹æ¨¡å¼â€ï¼Œçœ‹åˆ°å‰é¢éƒ½æ˜¯ä¸€æ ·çš„æ ·æ¿è¡Œä¸ºï¼Œå°±æ— è„‘å¤åˆ¶ç²˜è´´ï¼Œä¸è€ƒè™‘ä¸ªä½“å·®å¼‚ã€‚
- â€œèŠ‚å¥é”å®šâ€ä¸€æ—¦å‘ç”Ÿï¼Œåé¢çš„20æ¡è¾“å‡ºç¿»è½¦æ¦‚ç‡æé«˜ã€‚

### ğŸ” å¸¸è§è¯¯åŒº

- è¿½æ±‚æè‡´è§„èŒƒå¯¼è‡´ä¸Šä¸‹æ–‡ç¤ºä¾‹é«˜åº¦å¤åˆ¶ç²˜è´´ã€‚
- æ²¡æœ‰ä¸»åŠ¨å¼•å…¥â€œæ¨¡æ¿å¤šæ ·åŒ–â€â€œåŒä¹‰è¯å˜æ¢â€â€œé¡ºåºæ‰°åŠ¨â€ã€‚

### ğŸ› ï¸ æ­£ç¡®å·¥ç¨‹å®ç°

1. **å‡†å¤‡3-5å¥—ä¸åŒçš„æ¨¡æ¿ï¼Œè®°å½•è§‚æµ‹å’ŒåŠ¨ä½œæ—¶éšæœºé€‰ç”¨ã€‚**

2. **å¯¹äºJSONç­‰ç»“æ„ä½“è¦å®šæœŸæ‰°åŠ¨keyé¡ºåºï¼ˆæˆ–è¡¥å……å†—ä½™å­—æ®µä½¿æ ¼å¼ä¸èƒ½æ­»æ¿ï¼‰ã€‚**

3. **åŠ¨ä½œå‘½ä»¤/è§£é‡Šé‡Œå¯ä»¥å®‰æ’è½»åº¦â€œè¯­ä¹‰æ¼‚ç§»â€ï¼Œæ¯”å¦‚ç”¨â€œå–å¾—â€æ›¿ä»£â€œè·å–â€ï¼Œè®©æ¨¡å‹å­¦ä¼šåˆ†è¾¨è€Œéæœºæ¢°å¥—å£³ã€‚**

   ç¤ºä¾‹ä»£ç ï¼š

   ```
   templates = ["è¾“å‡ºå¦‚ä¸‹:\n{obs}", ">> {obs}", "[RESULT]\n{obs}"]
   def obs_record(obs):
       return random.choice(templates).format(obs=obs)
   ```

   

### âœ… æˆåŠŸæ•ˆæœ

- é›†åˆç¨³å®šåº¦æ˜¾è‘—æå‡ï¼Œæå¤§é™ä½â€œç¬¬äºŒæ¬¡èµ·å¹»è§‰â€é£é™©ã€‚
- é•¿é“¾ä»»åŠ¡ä¸å†å‡ºç°ä¸­åç¨‹â€œæ ¼å¼æºƒæ•£â€ã€‚



## 7. Predicted Outputs å¿«é€Ÿè·³è¿‡å·²çŸ¥æ–‡æœ¬

### ğŸŒŸ ä»‹ç»ä¸ç›®çš„

Predicted Outputs æ˜¯ OpenAIï¼ˆgpt-4o / 4.1 ç³»åˆ—ï¼‰æä¾›çš„æ¨ç†æœŸåŠ é€Ÿèƒ½åŠ›ï¼š
 å½“ä½ **å·²çŸ¥**ç»“æœé‡Œæœ‰ä¸€å¤§æ®µæ–‡å­—å¿…ç„¶åŸå°ä¸åŠ¨å‡ºç°æ—¶ï¼ŒæŠŠå®ƒä½œä¸º `prediction` ä¼ ç»™æ¨¡å‹ï¼›æ¨¡å‹é€ token æ ¡éªŒï¼Œä¸€è‡´å³â€œç›´æ¥é‡‡ç”¨â€ï¼Œä»è€Œ**è·³è¿‡é‡æ‰“**ã€‚å…¸å‹æ”¶ç›Šåœºæ™¯æ˜¯â€œ**å¤§æ–‡ä»¶å°æ”¹åŠ¨**â€ã€‚

### ğŸ¯ è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜

- **é‡å¤è§£ç æµªè´¹**ï¼šä¿®æ”¹ 3 è¡Œï¼Œæ¨¡å‹å´åˆæŠŠ 3 000 è¡Œæ—§ä»£ç é‡æ–°ç”Ÿæˆä¸€éã€‚
- **å¸¦å®½ä¸é¦–å­—èŠ‚å»¶è¿Ÿ**ï¼šå¤§æ®µå›æ˜¾æ‹–æ…¢æµå¼é¦– tokenã€‚
- **å‰ç¼€å·²é  KV-Cacheï¼Œä½† decode ä»é•¿**ï¼šPrefill çœä¸‹äº†ï¼Œç”Ÿæˆé˜¶æ®µè¿˜å¾—å†çœã€‚

### ğŸ” å¸¸è§è¯¯åŒº / è‡´å‘½é™·é˜±

| è¯¯åŒº                                       | åæœ                                                         |
| ------------------------------------------ | ------------------------------------------------------------ |
| â€œæ‰€æœ‰è°ƒç”¨ä¸€åˆ€åˆ‡å¼€ POâ€                      | æ™®é€šå¯¹è¯æˆ–å·¥å…·è°ƒç”¨å‘½ä¸­ç‡<30%ï¼Œrejected token å¤š â†’ åè€Œæ›´æ…¢æ›´è´µ |
| æŠŠ**æ•´ä»½**é¢„æµ‹ä¼ ä¸Šå»åˆä¸è®¾ `search_length` | é¢„æµ‹ç¨æœ‰é”™ï¼Œå‡ ç™¾ token è¢«é›†ä½“æ ‡è®° rejectedï¼Œç™½ä»˜è´¹           |
| åœ¨ function-calling åœºæ™¯å¼€å¯ PO            | ç›®å‰ä¸å…¼å®¹ï¼Œç›´æ¥ 400/å¤±è´¥                                    |
| ä¸ç›‘æ§ `accepted / rejected`               | å‘½ä¸­ç‡éª¤é™æ— äººçŸ¥ï¼Œè´¦å•çˆ†ç‚¸                                   |

### ğŸ› ï¸ æ­£ç¡®å·¥ç¨‹å®ç°

**æ»¡è¶³ä¸‰æ¡ä»¶å†å¯ç”¨**

- è¾“å‡º â‰¥ 80 % å¯æå‰ç¡®å®šï¼›
- æœ¬è½®ä¸éœ€è¦ tools / n>1 / presence_penaltyï¼›
- æ¨¡å‹ä¸º gpt-4o / 4.1 ç³»åˆ—ã€‚

**ç¤ºä¾‹ç®€è¿°ï¼š**
 ä¸‹é¢çš„ Python ä»£ç è°ƒç”¨ OpenAI GPT-4o-miniï¼Œå¹¶åœ¨ `prediction` å­—æ®µä¸­ç›´æ¥æäº¤æ•´ä»½æ—§ TypeScript æ–‡ä»¶ã€‚æ¨¡å‹å…ˆé€ token æ ¡éªŒè¿™æ®µä»£ç ï¼›å‡¡ä¸é¢„æµ‹ä¸€è‡´çš„éƒ¨åˆ†ç›´æ¥å¤ç”¨ï¼Œä»…ç”ŸæˆæŠŠ `username` æ”¹ä¸º `email` çš„å°‘é‡æ–°è¡Œï¼Œå› æ­¤å¤§å¹…ç¼©çŸ­è§£ç æ—¶é—´ã€‚æ‰§è¡Œåå¯é€šè¿‡ `accepted_prediction_tokens / rejected_prediction_tokens` å­—æ®µçœ‹åˆ°æœ‰å¤šå°‘é¢„æµ‹ token è¢«é‡‡çº³æˆ–æ‰“å›ã€‚

```
import openai
import os

openai.api_key = os.getenv("OPENAI_API_KEY")

# åŸå§‹ä»£ç æ–‡ä»¶ï¼ˆå¤§éƒ¨åˆ†å°†è¢«å¤ç”¨ï¼‰
code = """
class User {
  firstName: string = "";
  lastName:  string = "";
  username:  string = "";
}

export default User;
""".strip()

# æç¤ºï¼šå‘Šè¯‰æ¨¡å‹åªæ˜¯æŠŠ username æ”¹æˆ emailï¼Œä¸”åªè¿”å›ä»£ç 
refactor_prompt = (
    'Replace the "username" property with an "email" property. '
    "Respond only with code, and with no markdown formatting."
)

response = openai.chat.completions.create(
    model="gpt-4o-mini",        # ä»… gpt-4o / 4o-mini / 4.1 ç³»åˆ—æ”¯æŒ PO
    messages=[
        {"role": "user", "content": refactor_prompt},
        {"role": "user", "content": code}
    ],
    # â˜… æ ¸å¿ƒï¼šæŠŠæ•´ä»½æ—§æ–‡ä»¶å½“ä½œé¢„æµ‹æ–‡æœ¬
    prediction={
        "type": "content",
        "content": code
    }
)

print("=== æ–°æ–‡ä»¶ ===")
print(response.choices[0].message.content)

usage = response.usage.completion_tokens_details
print("\naccepted_prediction_tokens :", usage.accepted_prediction_tokens)
print("rejected_prediction_tokens :", usage.rejected_prediction_tokens)
```

***Refer toï¼š***

***https://medium.com/@peakji/context-engineering-for-ai-agents-lessons-from-building-manus-71883f0a67f2***

***https://platform.openai.com/docs/guides/predicted-outputs***
